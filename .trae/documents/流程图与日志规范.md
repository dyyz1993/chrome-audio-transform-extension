# 流程图与日志规范（TypeScript，Chrome MV3）

## 流程图（Mermaid）
```mermaid
flowchart TD
  A[内容脚本拦截 fetch/XHR] --> B{平台适配器解析}
  B -->|抖音: music/play_url & video/bit_rate| C[UnifiedExtractionResult]
  B -->|小红书: images/note.content| C
  C --> D[后台 orchestrator 校验+合并存储]
  D --> E[通知 Popover 刷新]
  D --> F{是否存在音频且已配置翻译接口}
  F -->|是| G[翻译任务提交: 下载音频→POST 上传]
  G --> H[翻译结果/状态缓存]
  H --> E
  F -->|否| E
  E --> I[Popover 智能展示: 文本/媒体/图片/状态]
  J[Options 设置页保存] --> K[chrome.storage.local.settings + 同步缓存]
  K --> F
```

## 日志规范
- 函数：`logDebug(scope, msg, data?)`、`logInfo(scope, msg)`、`logError(scope, err)`
- Scope 建议：
  - 拦截：`hook:fetch`、`hook:xhr`
  - 适配器：`adapter:douyin`、`adapter:xhs`
  - 核心：`core:orchestrator`、`core:storage`、`core:downloads`、`translate`
  - UI：`ui:popup`、`ui:options`
- 字段：包含 `timestamp`（由控制台生成）、`contextId`、`platform`、事件与关键数据（如 items 数量、键名、文件名、文本长度）。
- 开关：开发默认开启，生产可降级到 `info/error`。

## 抖音数据 Case（对齐规则）
- URL：`https://www.douyin.com/video/7575974733368266036` → 纯数字 ID `7575974733368266036`
- 音频：`music.play_url.url_list[0]`
- 视频：`video.bit_rate[*].play_addr.url_list[0]`
- 兜底：DOM `data-e2e="feed-active-video"` 的 `data-e2e-vid`

